rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============ HELPER FUNCTIONS ============

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is the owner of the resource
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Get user profile data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if user has a specific role
    function hasRole(role) {
      let userData = getUserData();
      return userData != null && role in userData.roles;
    }

    // Check if user is admin or superadmin
    function isAdmin() {
      return hasRole('admin') || hasRole('superadmin');
    }

    // Check if user is superadmin
    function isSuperAdmin() {
      return hasRole('superadmin');
    }

    // Check if user is the creator of a course
    function isCourseCreator(courseId) {
      let course = get(/databases/$(database)/documents/courses/$(courseId)).data;
      return course != null && course.creatorUid == request.auth.uid;
    }

    // Check if user can manage a course (creator or superadmin)
    function canManageCourse(courseId) {
      return isSuperAdmin() || (isAdmin() && isCourseCreator(courseId));
    }

    // ============ COURSES COLLECTION ============
    match /courses/{courseId} {
      // Anyone can read published courses
      allow read: if resource.data.isPublished == true;

      // Authenticated users can read any course by ID
      // (entitlement check is done in the app before showing protected content)
      // This allows the profile/dashboard to show purchased course metadata
      allow read: if isAuthenticated();

      // Admins can read their own courses (even unpublished)
      allow read: if isAdmin() && resource.data.creatorUid == request.auth.uid;

      // Superadmin can read all courses
      allow read: if isSuperAdmin();

      // Admins can create courses (must set themselves as creator)
      allow create: if isAdmin()
        && request.resource.data.creatorUid == request.auth.uid
        && request.resource.data.keys().hasAll(['title', 'subject', 'level', 'creatorUid', 'creatorName', 'isPublished']);

      // Course creator or superadmin can update
      allow update: if canManageCourse(courseId);

      // Course creator or superadmin can delete (only drafts)
      allow delete: if canManageCourse(courseId)
        && resource.data.isPublished == false;

      // Course outline subcollection
      match /outline/{itemId} {
        // Anyone can read outline
        allow read: if true;
        // Only course managers can write
        allow write: if canManageCourse(courseId);
      }
    }

    // ============ LESSONS COLLECTION ============
    match /lessons/{lessonId} {
      // Any authenticated user can read (entitlement check in app)
      allow read: if isAuthenticated();

      // Admins can create lessons
      allow create: if isAdmin()
        && request.resource.data.keys().hasAll(['courseId', 'title', 'type', 'order']);

      // Course creator or superadmin can update/delete
      allow update, delete: if isAuthenticated()
        && canManageCourse(resource.data.courseId);
    }

    // ============ QUESTIONS COLLECTION ============
    match /questions/{questionId} {
      // Authenticated users can read published questions
      allow read: if isAuthenticated() && resource.data.isPublished == true;

      // Admins can read unpublished questions for their courses
      allow read: if isAdmin() && canManageCourse(resource.data.courseId);

      // Admins can create questions
      allow create: if isAdmin()
        && request.resource.data.keys().hasAll(['courseId', 'questionText', 'options', 'correctOptionId', 'isPublished']);

      // Course creator or superadmin can update/delete
      allow update, delete: if isAuthenticated()
        && canManageCourse(resource.data.courseId);
    }

    // ============ USER PROFILES ============
    match /users/{userId} {
      // User can read their own profile
      allow read: if isOwner(userId);

      // Admins can read user profiles (filtered client-side by enrollment)
      allow read: if isAdmin();

      // Superadmin can read all profiles
      allow read: if isSuperAdmin();

      // User can update their own profile (except roles)
      allow update: if isOwner(userId)
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['roles']);

      // User can create their own profile
      allow create: if isOwner(userId);

      // Superadmin can update any profile (including roles)
      allow update: if isSuperAdmin();

      // Entitlements subcollection
      match /entitlements/{entId} {
        allow read: if isOwner(userId);

        allow create: if isOwner(userId)
          && request.resource.data.keys().hasAll(['type', 'refId', 'purchasedAt', 'source'])
          && request.resource.data.type in ['course', 'path', 'bundle']
          && request.resource.data.source in ['demo', 'payment'];

        // Prevent updates and deletes to maintain audit trail
        allow update, delete: if false;
      }

      // Course Progress subcollection
      match /courseProgress/{courseId} {
        allow read: if isOwner(userId);

        allow create, update: if isOwner(userId)
          && request.resource.data.keys().hasAll(['courseId', 'startedAt', 'lastAccessedAt', 'completedLessons', 'progressPercent']);

        allow delete: if false;
      }

      // Question Attempts subcollection
      match /questionAttempts/{attemptId} {
        allow read: if isOwner(userId);

        allow create: if isOwner(userId)
          && request.resource.data.keys().hasAll(['questionId', 'courseId', 'selectedOptionId', 'isCorrect', 'attemptedAt']);

        allow update, delete: if false;
      }

      // Notes subcollection
      match /notes/{noteId} {
        allow read: if isOwner(userId);

        allow create: if isOwner(userId)
          && request.resource.data.keys().hasAll(['courseId', 'content', 'userId', 'createdAt', 'updatedAt']);

        allow update: if isOwner(userId)
          && request.resource.data.userId == userId;

        allow delete: if isOwner(userId);
      }

      // Bookmarks subcollection
      match /bookmarks/{bookmarkId} {
        allow read: if isOwner(userId);

        allow create: if isOwner(userId)
          && request.resource.data.keys().hasAll(['lessonId', 'courseId', 'timestamp', 'createdAt']);

        allow update: if isOwner(userId);

        allow delete: if isOwner(userId);
      }
    }

    // ============ COURSE ENROLLMENTS ============
    // Reverse index of users enrolled in each course
    // Allows admins to query their students efficiently
    match /courseEnrollments/{courseId}/users/{userId} {
      // Superadmins can read all enrollments
      allow read: if isSuperAdmin();

      // Admins can read enrollments for their own courses
      allow read: if isAdmin() && isCourseCreator(courseId);

      // Authenticated users can create enrollments (via purchase flow)
      allow create: if isAuthenticated()
        && request.resource.data.keys().hasAll(['courseId', 'userEmail', 'userDisplayName', 'enrolledAt', 'source']);

      // Allow updates for progress tracking
      allow update: if isAuthenticated()
        && (isOwner(userId) || isSuperAdmin() || (isAdmin() && isCourseCreator(courseId)));

      // Prevent deletes to maintain audit trail
      allow delete: if false;
    }

    // ============ ADMIN INVITES ============
    match /invites/{inviteId} {
      // Anyone can read a specific invite (to validate the link)
      // This allows the invite acceptance page to check if an invite is valid
      allow read: if true;

      // Superadmin can create invites (no email required, supports admin/superadmin roles)
      allow create: if isSuperAdmin()
        && request.resource.data.keys().hasAll(['role', 'status', 'createdAt', 'createdBy', 'createdByName', 'expiresAt'])
        && request.resource.data.role in ['admin', 'superadmin']
        && request.resource.data.status == 'pending';

      // Superadmin can update invites (revoke)
      // Authenticated users can update to accept (mark as accepted with their info)
      allow update: if isSuperAdmin()
        || (isAuthenticated()
            && resource.data.status == 'pending'
            && request.resource.data.status == 'accepted'
            && request.resource.data.acceptedBy == request.auth.uid);

      // Prevent deletes to maintain audit trail
      allow delete: if false;
    }

    // ============ DEFAULT DENY ============
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
