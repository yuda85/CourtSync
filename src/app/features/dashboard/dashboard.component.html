<div class="dashboard">
  @if (isLoading()) {
    <!-- Loading State -->
    <div class="dashboard__loading">
      <div class="loading-hero">
        <div class="loading-shimmer"></div>
      </div>
      <div class="loading-stats">
        <div class="loading-stat"></div>
        <div class="loading-stat"></div>
        <div class="loading-stat"></div>
      </div>
      <div class="loading-grid">
        <div class="loading-card"></div>
        <div class="loading-card"></div>
        <div class="loading-card"></div>
      </div>
    </div>
  } @else if (vm()) {
    <!-- Welcome Header -->
    <header class="dashboard__header">
      <div class="header-content">
        <h1 class="header-title">
          שלום, {{ vm()!.user.displayName }}!
        </h1>
        <p class="header-subtitle">
          ברוך הבא חזרה. הנה ההתקדמות שלך.
        </p>
      </div>
      @if (vm()!.user.photoURL) {
        <img
          [src]="vm()!.user.photoURL"
          [alt]="vm()!.user.displayName"
          class="header-avatar"
        />
      } @else {
        <div class="header-avatar-placeholder">
          {{ vm()!.user.displayName[0] }}
        </div>
      }
    </header>

    <!-- Stats Bar -->
    <section class="dashboard__stats">
      <div class="stat-card stat-card--active">
        <div class="stat-icon">
          <span class="material-icons-outlined">menu_book</span>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ vm()!.stats.activeCourses }}</span>
          <span class="stat-label">קורסים פעילים</span>
        </div>
      </div>

      <div class="stat-card stat-card--complete">
        <div class="stat-icon">
          <span class="material-icons">check_circle</span>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ vm()!.stats.completedCourses }}</span>
          <span class="stat-label">קורסים שהושלמו</span>
        </div>
      </div>

      <div class="stat-card stat-card--lessons">
        <div class="stat-icon">
          <span class="material-icons">star</span>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ vm()!.stats.totalLessonsCompleted }}</span>
          <span class="stat-label">שיעורים שהושלמו</span>
        </div>
      </div>
    </section>

    <!-- Continue Learning Hero -->
    @if (vm()!.continueLearning.type !== 'empty') {
      <section class="dashboard__hero">
        <div class="hero-card">
          <div class="hero-badge">
            @if (vm()!.continueLearning.type === 'resume') {
              <span class="material-icons">play_arrow</span>
              המשך מאיפה שהפסקת
            } @else {
              <span class="material-icons-outlined">play_circle</span>
              התחל ללמוד
            }
          </div>

          <div class="hero-content">
            <div class="hero-info">
              <h2 class="hero-course-title">{{ vm()!.continueLearning.course?.title }}</h2>
              @if (vm()!.continueLearning.lesson) {
                <p class="hero-lesson-title">{{ vm()!.continueLearning.lesson!.title }}</p>
              }
              @if (vm()!.continueLearning.lastActivityLabel) {
                <span class="hero-activity">
                  <span class="material-icons-outlined">schedule</span>
                  {{ vm()!.continueLearning.lastActivityLabel }}
                </span>
              }
            </div>

            <div class="hero-progress">
              @if (vm()!.continueLearning.progressPercent !== undefined) {
                <app-progress-bar
                  [percent]="vm()!.continueLearning.progressPercent!"
                  size="md"
                  [showLabel]="true"
                />
                <span class="hero-progress-text">{{ vm()!.continueLearning.progressText }}</span>
              }
            </div>
          </div>

          <div class="hero-action">
            <app-button
              variant="primary"
              size="lg"
              (buttonClick)="onContinueLearning()"
            >
              <span class="material-icons btn-icon">play_arrow</span>
              {{ vm()!.continueLearning.ctaText }}
            </app-button>
          </div>
        </div>
      </section>
    }

    <!-- My Courses Section -->
    <section class="dashboard__courses">
      <div class="section-header">
        <h2 class="section-title">הקורסים שלי</h2>

        @if (hasCourses()) {
          <div class="section-controls">
            <!-- Search -->
            <div class="search-input">
              <span class="material-icons-outlined">search</span>
              <input
                type="text"
                placeholder="חיפוש קורס..."
                [value]="searchQuery()"
                (input)="onSearch($event)"
              />
            </div>

            <!-- Sort Dropdown -->
            <div class="sort-dropdown">
              <select [value]="sortBy()" (change)="onSortChange($any($event.target).value)">
                <option value="recent">לפי פעילות אחרונה</option>
                <option value="progress">לפי התקדמות</option>
                <option value="name">לפי שם</option>
              </select>
            </div>
          </div>
        }
      </div>

      @if (!hasCourses()) {
        <!-- Empty State: No Courses -->
        <app-empty-state
          icon="book"
          title="עדיין לא רכשת קורסים"
          description="גלה את מגוון הקורסים שלנו והתחל את המסע שלך להכנה למבחן"
          ctaText="עיין בקטלוג"
          (ctaClick)="onBrowseCatalog()"
        />
      } @else if (filteredCourses().length === 0) {
        <!-- Empty State: No Search Results -->
        <app-empty-state
          icon="search"
          title="לא נמצאו תוצאות"
          description="נסה לחפש מונח אחר או בטל את הסינון"
          size="sm"
        />
      } @else {
        <!-- Course Grid -->
        <div class="courses-grid">
          @for (card of filteredCourses(); track card.course.id) {
            <app-course-progress-card
              [data]="card"
              (cardClick)="onCourseClick($event)"
            />
          }
        </div>
      }
    </section>

    <!-- Recent Activity Section -->
    @if (vm()!.recentActivity.length > 0) {
      <section class="dashboard__activity">
        <h2 class="section-title">פעילות אחרונה</h2>
        <ul class="activity-list">
          @for (item of vm()!.recentActivity; track item.courseId) {
            <li class="activity-item">
              <a [routerLink]="item.route" class="activity-link">
                <div class="activity-info">
                  <span class="activity-course">{{ item.courseTitle }}</span>
                  <span class="activity-time">{{ item.lastActivityLabel }}</span>
                </div>
                <div class="activity-progress">
                  <app-progress-bar
                    [percent]="item.progressPercent"
                    size="sm"
                  />
                </div>
                <span class="material-icons-outlined activity-arrow">chevron_left</span>
              </a>
            </li>
          }
        </ul>
      </section>
    }

    <!-- Quick Links -->
    <section class="dashboard__quick-links">
      <h2 class="section-title">קישורים מהירים</h2>
      <div class="quick-links-grid">
        <button class="quick-link" (click)="onGoToLibrary()">
          <div class="quick-link-icon quick-link-icon--library">
            <span class="material-icons-outlined">local_library</span>
          </div>
          <span class="quick-link-text">הספרייה שלי</span>
        </button>

        <button class="quick-link" (click)="onBrowseCatalog()">
          <div class="quick-link-icon quick-link-icon--catalog">
            <span class="material-icons-outlined">search</span>
          </div>
          <span class="quick-link-text">כל הקורסים</span>
        </button>

        <button class="quick-link" (click)="onGoToProfile()">
          <div class="quick-link-icon quick-link-icon--profile">
            <span class="material-icons-outlined">person</span>
          </div>
          <span class="quick-link-text">פרופיל</span>
        </button>
      </div>
    </section>

    <!-- Exam Mode Placeholder -->
    <section class="dashboard__exam-mode">
      <div class="exam-placeholder">
        <div class="exam-icon">
          <span class="material-icons-outlined">assignment</span>
        </div>
        <div class="exam-content">
          <h3 class="exam-title">מצב חזרה למבחן</h3>
          <p class="exam-description">בקרוב: חזרה מהירה לפי נושאים ושיעורים שסימנת כחשובים.</p>
        </div>
        <app-button variant="outline" [disabled]="true">
          בקרוב
        </app-button>
      </div>
    </section>
  } @else {
    <!-- Error State -->
    <app-empty-state
      icon="chart"
      title="אירעה שגיאה"
      description="לא הצלחנו לטעון את הדשבורד. נסה לרענן את הדף."
      ctaText="רענן"
      (ctaClick)="onRefresh()"
    />
  }
</div>
